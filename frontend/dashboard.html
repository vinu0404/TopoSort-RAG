<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MRAG Â· Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #0b0d11;
    --surface:   #12151b;
    --surface2:  #181c24;
    --border:    #1f2330;
    --border2:   #282d3a;
    --accent:    #00d992;
    --accent-bg: rgba(0,217,146,0.08);
    --accent-b:  rgba(0,217,146,0.25);
    --blue:      #3b82f6;
    --blue-bg:   rgba(59,130,246,0.08);
    --blue-b:    rgba(59,130,246,0.25);
    --amber:     #f59e0b;
    --amber-bg:  rgba(245,158,11,0.08);
    --red:       #ef4444;
    --red-bg:    rgba(239,68,68,0.08);
    --purple:    #a78bfa;
    --purple-bg: rgba(167,139,250,0.08);
    --text:      #e4e7ee;
    --text2:     #a0a6b8;
    --text3:     #636a80;
    --text4:     #3e4458;
    --radius:    6px;
    --header-h:  52px;
    --sidebar-w: 240px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* â”€â”€ Topbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topbar {
    height: var(--header-h);
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
    padding: 0 20px; gap: 14px;
    flex-shrink: 0; z-index: 20;
  }
  .logo {
    font-weight: 700; font-size: 1rem;
    color: var(--accent);
    display: flex; align-items: center; gap: 8px;
    letter-spacing: -0.3px;
  }
  .logo .dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 10px var(--accent);
  }
  .topbar-sep { width: 1px; height: 22px; background: var(--border2); }
  .topbar-label { font-size: 0.7rem; color: var(--text3); letter-spacing: 0.5px; text-transform: uppercase; font-weight: 500; }
  .topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
  .status-pill {
    display: flex; align-items: center; gap: 6px;
    font-size: 0.68rem; color: var(--text3);
    padding: 4px 10px; border-radius: 20px;
    border: 1px solid var(--border2);
    background: var(--surface2);
  }
  .status-pill .sdot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--text4); transition: all 0.3s;
  }
  .status-pill.connected .sdot { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .status-pill.error .sdot { background: var(--red); box-shadow: 0 0 6px var(--red); }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .layout { flex: 1; display: flex; overflow: hidden; }

  /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sidebar {
    width: var(--sidebar-w); background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    overflow-y: auto; flex-shrink: 0;
  }
  .sidebar-section { padding: 16px 12px 8px; }
  .sidebar-heading {
    font-size: 0.6rem; font-weight: 600; color: var(--text3);
    text-transform: uppercase; letter-spacing: 1.2px;
    margin-bottom: 6px; padding-left: 8px;
  }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 10px; margin: 1px 0;
    border-radius: var(--radius); cursor: pointer;
    font-size: 0.78rem; color: var(--text2);
    transition: all 0.12s; border: 1px solid transparent;
  }
  .nav-item:hover { background: rgba(255,255,255,0.03); color: var(--text); }
  .nav-item.active {
    background: var(--accent-bg); color: var(--accent);
    border-color: var(--accent-b);
  }
  .nav-item .icon { font-size: 0.85rem; width: 22px; text-align: center; flex-shrink: 0; opacity: 0.6; }
  .nav-item.active .icon { opacity: 1; }
  .nav-item .label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .nav-badge {
    font-size: 0.6rem; font-weight: 600;
    padding: 2px 7px; border-radius: 10px;
    background: var(--surface2); color: var(--text3);
    min-width: 22px; text-align: center;
  }
  .nav-item.active .nav-badge { background: var(--accent-bg); color: var(--accent); }

  /* Stats */
  .sidebar-stats {
    margin-top: auto; padding: 14px 12px;
    border-top: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 4px;
  }
  .stat-row {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 0.68rem; color: var(--text3); padding: 2px 8px;
  }
  .stat-row .sv { color: var(--accent); font-weight: 600; }

  /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  /* â”€â”€ Summary cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .summary-bar {
    display: flex; gap: 10px; padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0; background: var(--surface);
    overflow-x: auto;
  }
  .summary-card {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 16px; border-radius: var(--radius);
    border: 1px solid var(--border2); background: var(--surface2);
    min-width: 140px; flex-shrink: 0;
  }
  .summary-card .sc-icon {
    width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.9rem;
  }
  .summary-card .sc-data { display: flex; flex-direction: column; }
  .summary-card .sc-val { font-size: 1.1rem; font-weight: 700; color: var(--text); }
  .summary-card .sc-lbl { font-size: 0.6rem; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }

  /* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toolbar {
    display: none; height: 46px; border-bottom: 1px solid var(--border);
    align-items: center; padding: 0 20px; gap: 10px;
    flex-shrink: 0; background: var(--surface);
  }
  .toolbar.visible { display: flex; }
  .tb-title { font-weight: 600; font-size: 0.85rem; color: var(--text); display: flex; align-items: center; gap: 6px; }
  .tb-title .schema { color: var(--text3); font-weight: 400; }
  .tb-count {
    font-size: 0.65rem; color: var(--text3); padding: 3px 8px;
    border: 1px solid var(--border2); border-radius: 3px;
    font-family: 'JetBrains Mono', monospace;
  }
  .tb-spacer { flex: 1; }
  .tb-search { position: relative; }
  .tb-search input {
    background: var(--bg); border: 1px solid var(--border2);
    color: var(--text); font-family: 'Inter', sans-serif;
    font-size: 0.72rem; padding: 6px 12px 6px 30px;
    border-radius: var(--radius); outline: none; width: 200px;
    transition: all 0.2s;
  }
  .tb-search input:focus { border-color: var(--accent); width: 280px; box-shadow: 0 0 0 2px rgba(0,217,146,0.1); }
  .tb-search .s-icon {
    position: absolute; left: 9px; top: 50%;
    transform: translateY(-50%); color: var(--text4);
    font-size: 0.78rem; pointer-events: none;
  }
  .tb-btn {
    font-family: 'Inter', sans-serif; font-size: 0.68rem; font-weight: 500;
    padding: 5px 12px; border-radius: var(--radius);
    border: 1px solid var(--border2); background: transparent;
    color: var(--text3); cursor: pointer;
    display: flex; align-items: center; gap: 5px;
    transition: all 0.12s;
  }
  .tb-btn:hover { color: var(--text); border-color: var(--text4); background: var(--surface2); }
  .tb-btn.spinning svg { animation: spin 0.6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading-bar { height: 2px; background: var(--border); position: relative; overflow: hidden; display: none; }
  .loading-bar.active { display: block; }
  .loading-bar::after {
    content: ''; position: absolute; height: 100%; width: 35%;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: loadbar 1s ease-in-out infinite;
  }
  @keyframes loadbar { 0%{left:-35%} 100%{left:100%} }

  /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-wrap { flex: 1; overflow: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.76rem; }
  thead { position: sticky; top: 0; z-index: 4; }
  thead th {
    background: var(--surface2); padding: 0;
    text-align: left; font-size: 0.62rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.8px; color: var(--text3);
    border-bottom: 2px solid var(--border);
    white-space: nowrap; user-select: none;
    position: relative;
  }
  thead th .th-inner {
    display: flex; align-items: center; gap: 4px;
    padding: 9px 14px; cursor: pointer; transition: color 0.12s;
  }
  thead th .th-inner:hover { color: var(--text); }
  thead th .sort-arrow { opacity: 0.25; font-size: 0.55rem; }
  thead th.sorted .sort-arrow { opacity: 1; color: var(--accent); }

  /* Column resize handle */
  thead th .col-resize {
    position: absolute; right: 0; top: 0; bottom: 0; width: 4px;
    cursor: col-resize; background: transparent;
    transition: background 0.15s;
  }
  thead th .col-resize:hover,
  thead th .col-resize.resizing { background: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.08s; cursor: pointer;
  }
  tbody tr:nth-child(even) { background: rgba(255,255,255,0.012); }
  tbody tr:hover { background: rgba(0,217,146,0.04); }
  tbody tr.selected { background: var(--accent-bg); }
  tbody td {
    padding: 8px 14px; color: var(--text);
    max-width: 320px; overflow: hidden;
    text-overflow: ellipsis; white-space: nowrap;
    vertical-align: middle;
  }

  /* Cell types */
  .c-uuid {
    font-family: 'JetBrains Mono', monospace; font-size: 0.65rem;
    color: var(--text3); cursor: pointer;
    display: inline-flex; align-items: center; gap: 4px;
  }
  .c-uuid:hover { color: var(--blue); }
  .c-uuid .short { color: var(--blue); font-weight: 500; }
  .c-uuid .copy-hint {
    opacity: 0; font-size: 0.5rem; color: var(--text4);
    transition: opacity 0.15s;
  }
  .c-uuid:hover .copy-hint { opacity: 1; }
  .c-bool { font-weight: 600; font-size: 0.68rem; display: inline-flex; align-items: center; gap: 4px; }
  .c-bool.t { color: var(--accent); }
  .c-bool.f { color: var(--red); }
  .c-null { color: var(--text4); font-style: italic; font-size: 0.65rem; }
  .c-date { color: var(--purple); font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; }
  .c-num { color: var(--blue); font-family: 'JetBrains Mono', monospace; }
  .c-json {
    font-family: 'JetBrains Mono', monospace; font-size: 0.62rem;
    color: var(--amber); cursor: pointer; padding: 2px 6px;
    border-radius: 3px; border: 1px solid rgba(245,158,11,0.15);
    background: var(--amber-bg);
    display: inline-block; max-width: 200px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .c-json:hover { border-color: var(--amber); }
  .c-text-long {
    cursor: pointer; position: relative;
    text-decoration: none; border-bottom: 1px dashed var(--text4);
    padding-bottom: 1px;
  }
  .c-text-long:hover { border-color: var(--accent); color: var(--accent); }

  /* Pill / badge */
  .pill {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px; border-radius: 20px;
    font-size: 0.64rem; font-weight: 600;
    letter-spacing: 0.3px; text-transform: capitalize;
  }
  .pill .pill-dot { width: 5px; height: 5px; border-radius: 50%; }
  .pill-success { background: var(--accent-bg); color: var(--accent); border: 1px solid var(--accent-b); }
  .pill-success .pill-dot { background: var(--accent); }
  .pill-failed  { background: var(--red-bg); color: var(--red); border: 1px solid rgba(239,68,68,0.25); }
  .pill-failed .pill-dot { background: var(--red); }
  .pill-pending { background: var(--surface2); color: var(--text3); border: 1px solid var(--border2); }
  .pill-pending .pill-dot { background: var(--text3); }
  .pill-running { background: var(--blue-bg); color: var(--blue); border: 1px solid var(--blue-b); }
  .pill-running .pill-dot { background: var(--blue); }
  .pill-user      { background: var(--blue-bg); color: var(--blue); border: 1px solid var(--blue-b); }
  .pill-assistant { background: var(--accent-bg); color: var(--accent); border: 1px solid var(--accent-b); }
  .pill-system    { background: var(--purple-bg); color: var(--purple); border: 1px solid rgba(167,139,250,0.25); }

  /* â”€â”€ Row Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .detail-panel {
    width: 0; overflow: hidden; flex-shrink: 0;
    background: var(--surface); border-left: 1px solid var(--border);
    transition: width 0.2s ease; display: flex; flex-direction: column;
  }
  .detail-panel.open { width: 420px; }
  .dp-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 16px; border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .dp-header .dp-title { font-weight: 600; font-size: 0.82rem; color: var(--text); }
  .dp-header .dp-subtitle { font-size: 0.62rem; color: var(--text3); margin-top: 2px; font-family: 'JetBrains Mono', monospace; }
  .dp-close {
    background: none; border: 1px solid var(--border2); color: var(--text3);
    width: 28px; height: 28px; border-radius: var(--radius); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.85rem; transition: all 0.12s;
  }
  .dp-close:hover { color: var(--text); border-color: var(--text4); }
  .dp-body { flex: 1; overflow-y: auto; padding: 4px 0; }
  .dp-field {
    padding: 10px 16px; border-bottom: 1px solid rgba(31,35,48,0.5);
    transition: background 0.08s;
  }
  .dp-field:hover { background: rgba(255,255,255,0.015); }
  .dp-field-name {
    font-size: 0.6rem; font-weight: 600; color: var(--text3);
    text-transform: uppercase; letter-spacing: 0.8px;
    margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;
  }
  .dp-field-val {
    font-size: 0.78rem; color: var(--text); line-height: 1.65;
    word-break: break-word; white-space: pre-wrap;
  }
  .dp-field-val.mono {
    font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
  }
  .dp-field-val.json-val {
    font-family: 'JetBrains Mono', monospace; font-size: 0.65rem;
    color: var(--amber); background: var(--surface2);
    padding: 8px 10px; border-radius: var(--radius);
    max-height: 200px; overflow-y: auto;
    border: 1px solid var(--border2); margin-top: 4px;
  }
  .dp-copy-btn {
    font-family: 'Inter', sans-serif; font-size: 0.58rem; font-weight: 500;
    padding: 2px 8px; border-radius: 3px;
    border: 1px solid var(--border2); background: transparent;
    color: var(--text3); cursor: pointer;
    transition: all 0.12s;
  }
  .dp-copy-btn:hover { color: var(--accent); border-color: var(--accent-b); }
  .dp-copy-btn.copied { color: var(--accent); border-color: var(--accent); }

  /* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pagination {
    height: 42px; border-top: 1px solid var(--border);
    display: none; align-items: center; padding: 0 16px; gap: 6px;
    flex-shrink: 0; background: var(--surface);
  }
  .pagination.visible { display: flex; }
  .pg-info { font-size: 0.66rem; color: var(--text3); margin-right: auto; font-family: 'JetBrains Mono', monospace; }
  .pg-btn {
    font-family: 'Inter', sans-serif; font-size: 0.66rem; font-weight: 500;
    padding: 4px 10px; border-radius: 4px;
    border: 1px solid var(--border2); background: transparent;
    color: var(--text3); cursor: pointer; transition: all 0.12s;
  }
  .pg-btn:hover:not(:disabled) { color: var(--text); border-color: var(--text4); }
  .pg-btn:disabled { opacity: 0.25; cursor: not-allowed; }
  .pg-btn.active { background: var(--accent-bg); color: var(--accent); border-color: var(--accent-b); }

  /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.65); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.18s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal-box {
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: 10px; width: 640px; max-width: 92vw; max-height: 80vh;
    display: flex; flex-direction: column;
    transform: translateY(6px) scale(0.98);
    transition: transform 0.18s;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .modal-overlay.open .modal-box { transform: translateY(0) scale(1); }
  .modal-top {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; border-bottom: 1px solid var(--border);
  }
  .modal-top .m-title { font-weight: 600; font-size: 0.82rem; }
  .modal-top .m-actions { display: flex; gap: 6px; }
  .modal-top .m-btn {
    font-family: 'Inter', sans-serif; font-size: 0.62rem; font-weight: 500;
    padding: 4px 10px; border-radius: 4px;
    border: 1px solid var(--border2); background: transparent;
    color: var(--text3); cursor: pointer; transition: all 0.12s;
  }
  .modal-top .m-btn:hover { color: var(--text); border-color: var(--text4); }
  .modal-content { padding: 16px 18px; overflow-y: auto; flex: 1; }
  .modal-content pre {
    font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
    line-height: 1.75; white-space: pre-wrap; word-break: break-word;
  }
  .modal-content pre.json-pre { color: var(--amber); }
  .modal-content pre.text-pre { color: var(--text); }

  /* â”€â”€ Empty states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .empty-state {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    height: 100%; gap: 14px; color: var(--text3);
  }
  .empty-state .es-icon { font-size: 2.5rem; opacity: 0.2; }
  .empty-state p { text-align: center; line-height: 1.7; font-size: 0.8rem; max-width: 340px; }

  /* â”€â”€ Connect screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .connect-screen {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    flex: 1; gap: 16px; padding: 40px;
  }
  .connect-screen h2 { font-size: 1.3rem; font-weight: 700; color: var(--text); }
  .connect-screen p { font-size: 0.78rem; color: var(--text3); text-align: center; max-width: 420px; line-height: 1.7; }
  .connect-screen .hint-box {
    font-size: 0.7rem; padding: 10px 16px;
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: var(--radius); color: var(--text3);
    max-width: 440px; width: 100%; text-align: center;
  }
  .connect-screen .hint-box strong { color: var(--accent); }
  .connect-screen .hint-box code { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    position: fixed; bottom: 20px; right: 20px; z-index: 200;
    background: var(--surface2); border: 1px solid var(--accent-b);
    border-radius: var(--radius); padding: 10px 16px;
    font-size: 0.72rem; color: var(--accent);
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    transform: translateY(80px); opacity: 0; transition: all 0.25s;
    display: flex; align-items: center; gap: 8px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* â”€â”€ Scrollbars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text4); }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 768px) {
    .sidebar { display: none; }
    .detail-panel.open { width: 100%; position: absolute; right: 0; top: 0; bottom: 0; z-index: 30; }
    .summary-bar { padding: 10px; }
    .summary-card { min-width: 110px; padding: 8px 12px; }
  }
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="logo"><span class="dot"></span>MRAG</div>
  <div class="topbar-sep"></div>
  <span class="topbar-label">Admin Dashboard</span>
  <div class="topbar-right">
    <div class="status-pill" id="statusPill">
      <span class="sdot"></span>
      <span id="statusLabel">Connectingâ€¦</span>
    </div>
  </div>
</div>

<!-- Layout -->
<div class="layout" id="mainLayout" style="display:none">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-heading">Tables</div>
      <div id="tableNav"></div>
    </div>
    <div class="sidebar-stats" id="sidebarStats"></div>
  </aside>

  <!-- Main area -->
  <div class="main">
    <!-- Summary cards -->
    <div class="summary-bar" id="summaryBar"></div>

    <!-- Toolbar -->
    <div class="toolbar" id="toolbar">
      <span class="tb-title" id="tbTitle"></span>
      <span class="tb-count" id="tbCount"></span>
      <span class="tb-spacer"></span>
      <div class="tb-search">
        <span class="s-icon">âŒ•</span>
        <input type="text" id="searchInput" placeholder="Search rowsâ€¦">
      </div>
      <button class="tb-btn" id="colToggleBtn" onclick="toggleColumnPicker()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Columns
      </button>
      <button class="tb-btn" onclick="exportCSV()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Export
      </button>
      <button class="tb-btn" id="refreshBtn" onclick="refreshData()">
        <svg id="refreshIcon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        Refresh
      </button>
    </div>

    <!-- Column picker dropdown -->
    <div id="colPicker" style="display:none;position:absolute;z-index:15;background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);padding:8px;max-height:300px;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,0.4);font-size:0.72rem;min-width:200px;"></div>

    <div class="loading-bar" id="loadingBar"></div>

    <div style="flex:1;display:flex;overflow:hidden;">
      <div class="table-wrap" id="tableWrap"></div>
      <!-- Row detail panel -->
      <div class="detail-panel" id="detailPanel">
        <div class="dp-header">
          <div>
            <div class="dp-title" id="dpTitle">Row Details</div>
            <div class="dp-subtitle" id="dpSubtitle"></div>
          </div>
          <button class="dp-close" onclick="closeDetail()">âœ•</button>
        </div>
        <div class="dp-body" id="dpBody"></div>
      </div>
    </div>

    <div class="pagination" id="pagination">
      <span class="pg-info" id="pgInfo"></span>
      <button class="pg-btn" id="prevBtn" onclick="changePage(-1)">â† Prev</button>
      <span id="pgNums" style="display:flex;gap:3px;"></span>
      <button class="pg-btn" id="nextBtn" onclick="changePage(1)">Next â†’</button>
    </div>
  </div>
</div>

<!-- Connect screen -->
<div class="connect-screen" id="connectScreen">
  <h2>Connecting to Databaseâ€¦</h2>
  <p>Fetching data from the MRAG backend automatically.</p>
  <div class="hint-box">Make sure <strong>dashboard_server.py</strong> is running<br>
    <code>python dashboard_server.py</code></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <div class="modal-top">
      <span class="m-title" id="modalTitle">Value</span>
      <div class="m-actions">
        <button class="m-btn" id="copyModalBtn" onclick="copyModalContent()">Copy</button>
        <button class="m-btn" onclick="closeModal()">âœ• Close</button>
      </div>
    </div>
    <div class="modal-content">
      <pre id="modalPre"></pre>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABLES = [
  { name: 'users',                  icon: 'ğŸ‘¤' },
  { name: 'sessions',               icon: 'ğŸ”—' },
  { name: 'conversations',          icon: 'ğŸ’¬' },
  { name: 'messages',               icon: 'ğŸ“¨' },
  { name: 'agent_executions',       icon: 'ğŸ¤–' },
  { name: 'documents',              icon: 'ğŸ“„' },
  { name: 'conversation_summaries', icon: 'ğŸ“' },
  { name: 'user_long_term_memory',  icon: 'ğŸ§ ' },
];

const BACKEND = 'http://localhost:8080';
const PAGE_SIZE = 50;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DB = {};
let activeTable = null;
let sortCol = null, sortDir = 'asc';
let searchQuery = '';
let currentPage = 1;
let selectedRowIdx = null;
let hiddenCols = new Set();
let _cellStore = {}, _cellId = 0;
let _colWidths = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', autoConnect);

async function autoConnect() {
  setStatus('connecting');
  try {
    const r = await fetch(`${BACKEND}/api/db-snapshot`);
    if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    const data = await r.json();
    if (data.error) throw new Error(data.error);
    ingestData(data);
  } catch (e) {
    setStatus('error');
    showConnError(e.message);
  }
}

function ingestData(payload) {
  DB = {};
  for (const t of TABLES) DB[t.name] = Array.isArray(payload[t.name]) ? payload[t.name] : [];
  setStatus('connected');
  document.getElementById('connectScreen').style.display = 'none';
  document.getElementById('mainLayout').style.display = 'flex';
  buildSidebar();
  buildSummary();
  const first = TABLES.find(t => DB[t.name].length > 0) || TABLES[0];
  selectTable(first.name);
}

function showConnError(msg) {
  document.getElementById('connectScreen').innerHTML = `
    <h2 style="color:var(--red)">Connection Failed</h2>
    <p style="color:var(--text2);font-family:'JetBrains Mono',monospace;font-size:0.7rem;white-space:pre-wrap;max-width:480px;">${esc(msg)}</p>
    <div class="hint-box" style="margin-top:8px;">Start the server: <code>python dashboard_server.py</code></div>
    <button class="tb-btn" onclick="autoConnect()" style="padding:10px 28px;margin-top:16px;font-size:0.78rem;">â†» Retry</button>
  `;
}

function setStatus(s) {
  const pill = document.getElementById('statusPill');
  const lbl = document.getElementById('statusLabel');
  pill.className = 'status-pill ' + (s === 'connected' ? 'connected' : s === 'error' ? 'error' : '');
  lbl.textContent = s === 'connected' ? 'Connected' : s === 'error' ? 'Error' : 'Connectingâ€¦';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sidebar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSidebar() {
  document.getElementById('tableNav').innerHTML = TABLES.map(t => `
    <div class="nav-item" id="nav-${t.name}" onclick="selectTable('${t.name}')">
      <span class="icon">${t.icon}</span>
      <span class="label">${t.name}</span>
      <span class="nav-badge">${DB[t.name].length}</span>
    </div>
  `).join('');

  const total = Object.values(DB).reduce((s, r) => s + r.length, 0);
  document.getElementById('sidebarStats').innerHTML = `
    <div class="stat-row"><span>Total records</span><span class="sv">${total.toLocaleString()}</span></div>
    <div class="stat-row"><span>Tables</span><span class="sv">${TABLES.length}</span></div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Summary cards
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSummary() {
  const cards = [
    { icon: 'ğŸ‘¤', label: 'Users',       val: DB.users?.length || 0, bg: 'var(--blue-bg)',   bc: 'var(--blue-b)' },
    { icon: 'ğŸ’¬', label: 'Conversations', val: DB.conversations?.length || 0, bg: 'var(--accent-bg)', bc: 'var(--accent-b)' },
    { icon: 'ğŸ“¨', label: 'Messages',    val: DB.messages?.length || 0, bg: 'var(--amber-bg)', bc: 'rgba(245,158,11,0.25)' },
    { icon: 'ğŸ¤–', label: 'Agent Runs',  val: DB.agent_executions?.length || 0, bg: 'var(--purple-bg)', bc: 'rgba(167,139,250,0.25)' },
    { icon: 'ğŸ“„', label: 'Documents',   val: DB.documents?.length || 0, bg: 'var(--blue-bg)',  bc: 'var(--blue-b)' },
    { icon: 'ğŸ§ ', label: 'Memories',    val: DB.user_long_term_memory?.length || 0, bg: 'var(--accent-bg)', bc: 'var(--accent-b)' },
  ];
  document.getElementById('summaryBar').innerHTML = cards.map(c => `
    <div class="summary-card">
      <div class="sc-icon" style="background:${c.bg};border:1px solid ${c.bc};">${c.icon}</div>
      <div class="sc-data">
        <span class="sc-val">${c.val.toLocaleString()}</span>
        <span class="sc-lbl">${c.label}</span>
      </div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Table logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectTable(name) {
  activeTable = name;
  sortCol = null; sortDir = 'asc';
  searchQuery = ''; currentPage = 1;
  selectedRowIdx = null;
  hiddenCols = new Set();
  document.getElementById('searchInput').value = '';
  closeDetail();
  closeColumnPicker();

  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const nav = document.getElementById(`nav-${name}`);
  if (nav) nav.classList.add('active');

  document.getElementById('toolbar').classList.add('visible');
  document.getElementById('pagination').classList.add('visible');
  renderTable();
}

async function refreshData() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  document.getElementById('loadingBar').classList.add('active');
  try {
    const r = await fetch(`${BACKEND}/api/db-snapshot`);
    if (r.ok) {
      const data = await r.json();
      ingestData(data);
      if (activeTable) selectTable(activeTable);
      toast('Data refreshed');
    }
  } catch (e) { console.error(e); }
  finally {
    setTimeout(() => {
      btn.classList.remove('spinning');
      document.getElementById('loadingBar').classList.remove('active');
    }, 400);
  }
}

document.getElementById('searchInput').addEventListener('input', e => {
  searchQuery = e.target.value.toLowerCase();
  currentPage = 1;
  renderTable();
});

function getVisibleColumns() {
  const rows = DB[activeTable] || [];
  const allCols = new Set();
  rows.forEach(r => Object.keys(r).forEach(k => allCols.add(k)));
  return [...allCols].filter(c => !hiddenCols.has(c));
}

function getAllColumns() {
  const rows = DB[activeTable] || [];
  const allCols = new Set();
  rows.forEach(r => Object.keys(r).forEach(k => allCols.add(k)));
  return [...allCols];
}

function getFilteredRows() {
  const rows = DB[activeTable] || [];
  const cols = getAllColumns();
  let filtered = rows;
  if (searchQuery) {
    filtered = rows.filter(r =>
      cols.some(c => {
        const v = r[c];
        if (v == null) return false;
        return String(typeof v === 'object' ? JSON.stringify(v) : v).toLowerCase().includes(searchQuery);
      })
    );
  }
  if (sortCol) {
    filtered = [...filtered].sort((a, b) => {
      let va = a[sortCol] ?? '', vb = b[sortCol] ?? '';
      const cmp = String(va).localeCompare(String(vb), undefined, { numeric: true });
      return sortDir === 'asc' ? cmp : -cmp;
    });
  }
  return filtered;
}

function renderTable() {
  if (!activeTable) return;
  const rows = DB[activeTable] || [];
  _cellStore = {}; _cellId = 0;

  const cols = getVisibleColumns();
  const filtered = getFilteredRows();

  const total = filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  currentPage = Math.min(currentPage, totalPages);
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = filtered.slice(start, start + PAGE_SIZE);

  // Toolbar
  document.getElementById('tbTitle').innerHTML = `<span class="schema">public.</span>${activeTable}`;
  document.getElementById('tbCount').textContent = searchQuery
    ? `${total} / ${rows.length} rows` : `${rows.length} rows`;

  const wrap = document.getElementById('tableWrap');

  if (cols.length === 0 || rows.length === 0) {
    wrap.innerHTML = `<div class="empty-state"><div class="es-icon">â—‹</div><p>No data in <strong>${activeTable}</strong></p></div>`;
    updatePagination(0, 0, 1);
    return;
  }

  if (pageRows.length === 0 && searchQuery) {
    wrap.innerHTML = `<div class="empty-state"><div class="es-icon">âŒ€</div><p>No rows match "<strong>${esc(searchQuery)}</strong>"</p></div>`;
    updatePagination(0, 0, 1);
    return;
  }

  // Build header
  const thHtml = cols.map(c => {
    const sorted = sortCol === c;
    const arrow = sorted ? (sortDir === 'asc' ? 'â†‘' : 'â†“') : 'â†•';
    const w = _colWidths[activeTable + '.' + c];
    const style = w ? `style="width:${w}px;min-width:${w}px;"` : '';
    return `<th class="${sorted ? 'sorted' : ''}" ${style}>
      <div class="th-inner" onclick="sortBy('${c}')">
        ${esc(c)} <span class="sort-arrow">${arrow}</span>
      </div>
      <div class="col-resize" onmousedown="startResize(event,'${c}')"></div>
    </th>`;
  }).join('');

  // Build rows
  const trHtml = pageRows.map((row, i) => {
    const globalIdx = start + i;
    const selClass = selectedRowIdx === globalIdx ? ' selected' : '';
    const tds = cols.map(c => `<td>${renderCell(c, row[c])}</td>`).join('');
    return `<tr class="${selClass}" onclick="selectRow(${globalIdx}, event)">${tds}</tr>`;
  }).join('');

  wrap.innerHTML = `<table><thead><tr>${thHtml}</tr></thead><tbody>${trHtml}</tbody></table>`;
  updatePagination(start, total, totalPages);
}

function updatePagination(start, total, totalPages) {
  document.getElementById('pgInfo').textContent = total > 0
    ? `${start + 1}â€“${Math.min(start + PAGE_SIZE, total)} of ${total}`
    : '0 rows';
  const pn = document.getElementById('pgNums');
  pn.innerHTML = '';
  const w = 3;
  for (let p = Math.max(1, currentPage - w); p <= Math.min(totalPages, currentPage + w); p++) {
    const b = document.createElement('button');
    b.className = 'pg-btn' + (p === currentPage ? ' active' : '');
    b.textContent = p;
    b.onclick = () => { currentPage = p; renderTable(); };
    pn.appendChild(b);
  }
  document.getElementById('prevBtn').disabled = currentPage <= 1;
  document.getElementById('nextBtn').disabled = currentPage >= totalPages;
}

function sortBy(col) {
  if (sortCol === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  else { sortCol = col; sortDir = 'asc'; }
  renderTable();
}

function changePage(d) { currentPage += d; renderTable(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Cell rendering
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCell(col, val) {
  if (val == null) return `<span class="c-null">NULL</span>`;

  // Boolean
  if (val === true || val === false) {
    return val
      ? `<span class="c-bool t">â— true</span>`
      : `<span class="c-bool f">â—‹ false</span>`;
  }

  // Status pill
  if (col === 'status') {
    const cls = { success:'pill-success', failed:'pill-failed', pending:'pill-pending', running:'pill-running' }[val] || 'pill-pending';
    return `<span class="pill ${cls}"><span class="pill-dot"></span>${esc(val)}</span>`;
  }

  // Role pill
  if (col === 'role') {
    const cls = { user:'pill-user', assistant:'pill-assistant', system:'pill-system' }[val] || 'pill-pending';
    return `<span class="pill ${cls}">${esc(val)}</span>`;
  }

  // UUID â€” click to copy
  const uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (typeof val === 'string' && uuidRe.test(val)) {
    return `<span class="c-uuid" onclick="event.stopPropagation();copyText('${val}')" title="${val}">
      <span class="short">${val.slice(0, 8)}</span>â€¦${val.slice(-4)}
      <span class="copy-hint">copy</span>
    </span>`;
  }

  // Datetime
  if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(val)) {
    const d = new Date(val);
    if (!isNaN(d)) {
      const fmt = d.toLocaleString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
      });
      return `<span class="c-date" title="${esc(val)}">${fmt}</span>`;
    }
  }

  // JSON object/array
  if (typeof val === 'object') {
    const json = JSON.stringify(val);
    const preview = json.length > 50 ? json.slice(0, 50) + 'â€¦' : json;
    const id = storeCell(json, 'json', col);
    return `<span class="c-json" onclick="event.stopPropagation();showModal(${id})">${esc(preview)}</span>`;
  }

  // Number
  if (typeof val === 'number') return `<span class="c-num">${val.toLocaleString()}</span>`;

  // Long text
  const s = String(val);
  if (s.length > 100) {
    const id = storeCell(s, 'text', col);
    return `<span class="c-text-long" onclick="event.stopPropagation();showModal(${id})">${esc(s.slice(0, 100))}â€¦</span>`;
  }

  return esc(s);
}

function storeCell(v, type, col) {
  const id = ++_cellId;
  _cellStore[id] = { value: v, type, col };
  return id;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Row detail panel
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectRow(idx, event) {
  // Don't open detail if clicking interactive cells
  if (event && (event.target.closest('.c-uuid') || event.target.closest('.c-json') || event.target.closest('.c-text-long'))) return;
  selectedRowIdx = idx;
  const filtered = getFilteredRows();
  const row = filtered[idx];
  if (!row) return;

  const allCols = getAllColumns();
  const panel = document.getElementById('detailPanel');
  const body = document.getElementById('dpBody');

  // Find a good title from ID column
  const idCol = allCols.find(c => c.endsWith('_id') || c === 'id');
  const idVal = idCol ? row[idCol] : null;
  document.getElementById('dpTitle').textContent = 'Row Details';
  document.getElementById('dpSubtitle').textContent = idVal ? `${idCol}: ${String(idVal).slice(0, 36)}` : `Row ${idx + 1}`;

  body.innerHTML = allCols.map(c => {
    const v = row[c];
    const rawVal = v == null ? '' : (typeof v === 'object' ? JSON.stringify(v, null, 2) : String(v));
    const copyId = storeCell(rawVal, 'raw', c);
    return `<div class="dp-field">
      <div class="dp-field-name">
        ${esc(c)}
        <button class="dp-copy-btn" onclick="copyFieldValue(this, ${copyId})">Copy</button>
      </div>
      <div class="dp-field-val ${getDetailClass(c, v)}">${renderDetailValue(c, v)}</div>
    </div>`;
  }).join('');

  panel.classList.add('open');
  renderTable();
}

function getDetailClass(col, val) {
  if (val == null) return '';
  if (typeof val === 'object') return 'json-val mono';
  const uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (typeof val === 'string' && uuidRe.test(val)) return 'mono';
  if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(val)) return 'mono';
  return '';
}

function renderDetailValue(col, val) {
  if (val == null) return '<span style="color:var(--text4);font-style:italic;">NULL</span>';
  if (typeof val === 'boolean') {
    return val
      ? '<span style="color:var(--accent);font-weight:600;">true</span>'
      : '<span style="color:var(--red);font-weight:600;">false</span>';
  }
  if (typeof val === 'object') {
    try { return esc(JSON.stringify(val, null, 2)); }
    catch { return esc(String(val)); }
  }
  if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(val)) {
    const d = new Date(val);
    if (!isNaN(d)) {
      return `<span style="color:var(--purple);">${d.toLocaleString('en-US', {
        weekday:'short', year:'numeric', month:'short', day:'numeric',
        hour:'2-digit', minute:'2-digit', second:'2-digit', timeZoneName:'short'
      })}</span>`;
    }
  }
  return esc(String(val));
}

function closeDetail() {
  selectedRowIdx = null;
  document.getElementById('detailPanel').classList.remove('open');
}

function copyFieldValue(btn, id) {
  const entry = _cellStore[id];
  if (!entry) return;
  copyText(entry.value);
  btn.textContent = 'âœ“ Copied';
  btn.classList.add('copied');
  setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(id) {
  const entry = _cellStore[id];
  if (!entry) return;
  const pre = document.getElementById('modalPre');
  const title = document.getElementById('modalTitle');
  if (entry.type === 'json') {
    title.textContent = entry.col ? `${entry.col} (JSON)` : 'JSON Value';
    pre.className = 'json-pre';
    try { pre.textContent = JSON.stringify(JSON.parse(entry.value), null, 2); }
    catch { pre.textContent = entry.value; }
  } else {
    title.textContent = entry.col || 'Full Content';
    pre.className = 'text-pre';
    pre.textContent = entry.value;
  }
  document.getElementById('modal').classList.add('open');
}

function closeModal() { document.getElementById('modal').classList.remove('open'); }

function copyModalContent() {
  const text = document.getElementById('modalPre').textContent;
  copyText(text);
  const btn = document.getElementById('copyModalBtn');
  btn.textContent = 'âœ“ Copied';
  setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Column picker
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleColumnPicker() {
  const el = document.getElementById('colPicker');
  if (el.style.display !== 'none') { closeColumnPicker(); return; }
  const allCols = getAllColumns();
  el.innerHTML = `<div style="font-size:0.58rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;padding:2px 4px;font-weight:600;">Toggle Columns</div>`
    + allCols.map(c => {
      const checked = !hiddenCols.has(c) ? 'checked' : '';
      return `<label style="display:flex;align-items:center;gap:8px;padding:5px 6px;cursor:pointer;border-radius:3px;color:var(--text2);transition:background 0.1s;"
                onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" ${checked} onchange="toggleCol('${c}', this.checked)" style="accent-color:var(--accent);width:14px;height:14px;">
        ${esc(c)}
      </label>`;
    }).join('');

  const btn = document.getElementById('colToggleBtn');
  const rect = btn.getBoundingClientRect();
  el.style.left = Math.min(rect.left, window.innerWidth - 220) + 'px';
  el.style.top = (rect.bottom + 4) + 'px';
  el.style.display = 'block';
}

function closeColumnPicker() { document.getElementById('colPicker').style.display = 'none'; }

function toggleCol(col, show) {
  if (show) hiddenCols.delete(col); else hiddenCols.add(col);
  renderTable();
}

document.addEventListener('click', e => {
  const picker = document.getElementById('colPicker');
  const btn = document.getElementById('colToggleBtn');
  if (picker.style.display !== 'none' && !picker.contains(e.target) && !btn.contains(e.target)) {
    closeColumnPicker();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Column resize
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _resizeCol = null, _resizeStart = 0, _resizeWidth = 0;

function startResize(e, col) {
  e.preventDefault(); e.stopPropagation();
  _resizeCol = col;
  _resizeStart = e.clientX;
  _resizeWidth = e.target.parentElement.offsetWidth;
  e.target.classList.add('resizing');
  document.addEventListener('mousemove', onResize);
  document.addEventListener('mouseup', endResize);
}

function onResize(e) {
  if (!_resizeCol) return;
  const diff = e.clientX - _resizeStart;
  const newW = Math.max(60, _resizeWidth + diff);
  _colWidths[activeTable + '.' + _resizeCol] = newW;
  const cols = getVisibleColumns();
  const idx = cols.indexOf(_resizeCol);
  const ths = document.querySelectorAll('thead th');
  if (idx >= 0 && ths[idx]) {
    ths[idx].style.width = newW + 'px';
    ths[idx].style.minWidth = newW + 'px';
  }
}

function endResize() {
  document.querySelectorAll('.col-resize.resizing').forEach(el => el.classList.remove('resizing'));
  _resizeCol = null;
  document.removeEventListener('mousemove', onResize);
  document.removeEventListener('mouseup', endResize);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Export CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  if (!activeTable) return;
  const cols = getVisibleColumns();
  const filtered = getFilteredRows();
  let csv = cols.map(c => `"${c}"`).join(',') + '\n';
  for (const row of filtered) {
    csv += cols.map(c => {
      let v = row[c];
      if (v == null) return '';
      if (typeof v === 'object') v = JSON.stringify(v);
      return `"${String(v).replace(/"/g, '""')}"`;
    }).join(',') + '\n';
  }
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${activeTable}_${new Date().toISOString().slice(0, 10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast(`Exported ${filtered.length} rows`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Utilities
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => toast('Copied to clipboard'));
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = 'âœ“ ' + msg;
  el.classList.add('show');
  clearTimeout(el._timer);
  el._timer = setTimeout(() => el.classList.remove('show'), 2200);
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeColumnPicker(); closeDetail(); }
});
</script>
</body>
</html>

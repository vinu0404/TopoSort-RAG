<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MRAG Â· Database Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #0a0b0e;
    --surface:  #111318;
    --border:   #1e2028;
    --border2:  #2a2d38;
    --accent:   #00e5a0;
    --accent2:  #0099ff;
    --warn:     #ff6b35;
    --text:     #e8eaf0;
    --muted:    #5a5f72;
    --muted2:   #3a3f52;
    --header-h: 56px;
    --sidebar-w: 220px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topbar {
    height: var(--header-h);
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 16px;
    flex-shrink: 0;
    position: relative;
    z-index: 10;
  }
  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.1rem;
    color: var(--accent);
    letter-spacing: -0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .logo::before {
    content: '';
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 12px var(--accent);
  }
  .topbar-sep { width: 1px; height: 24px; background: var(--border2); }
  .topbar-label {
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .db-config {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  .btn {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    padding: 6px 14px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    font-weight: 500;
    letter-spacing: 0.3px;
  }
  .btn-primary {
    background: var(--accent);
    color: #000;
  }
  .btn-primary:hover { opacity: 0.85; }
  .btn-primary:disabled { opacity: 0.3; cursor: not-allowed; }
  .btn-ghost {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border2);
  }
  .btn-ghost:hover { color: var(--text); border-color: var(--muted2); }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--muted2);
    transition: background 0.3s, box-shadow 0.3s;
    flex-shrink: 0;
  }
  .status-dot.connected { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
  .status-dot.error { background: var(--warn); box-shadow: 0 0 8px var(--warn); }
  .status-text { font-size: 0.7rem; color: var(--muted); }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .layout {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sidebar {
    width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    flex-shrink: 0;
  }
  .sidebar-section {
    padding: 16px 14px 8px;
  }
  .sidebar-section-title {
    font-size: 0.6rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 8px;
    padding-left: 4px;
  }
  .table-nav-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.78rem;
    color: var(--muted);
    transition: all 0.15s;
    gap: 8px;
    border: 1px solid transparent;
  }
  .table-nav-item:hover { background: var(--border); color: var(--text); }
  .table-nav-item.active {
    background: rgba(0,229,160,0.08);
    color: var(--accent);
    border-color: rgba(0,229,160,0.2);
  }
  .table-nav-item .tname { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .table-badge {
    font-size: 0.6rem;
    padding: 2px 6px;
    border-radius: 10px;
    background: var(--border2);
    color: var(--muted);
    flex-shrink: 0;
    min-width: 24px;
    text-align: center;
  }
  .table-nav-item.active .table-badge {
    background: rgba(0,229,160,0.15);
    color: var(--accent);
  }
  .table-nav-item .t-icon {
    font-size: 0.75rem;
    opacity: 0.5;
    flex-shrink: 0;
  }

  .sidebar-stats {
    margin-top: auto;
    padding: 14px;
    border-top: 1px solid var(--border);
  }
  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.68rem;
    color: var(--muted);
    padding: 3px 0;
  }
  .stat-row span:last-child { color: var(--accent); }

  /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ Table toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-toolbar {
    height: 48px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 12px;
    flex-shrink: 0;
    background: var(--surface);
  }
  .table-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--text);
  }
  .table-title .schema-prefix { color: var(--muted); font-weight: 400; }
  .row-count {
    font-size: 0.68rem;
    color: var(--muted);
    padding: 3px 8px;
    border: 1px solid var(--border2);
    border-radius: 3px;
  }

  .search-wrap {
    position: relative;
    margin-left: auto;
  }
  .search-wrap input {
    background: var(--bg);
    border: 1px solid var(--border2);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    padding: 5px 10px 5px 28px;
    border-radius: 4px;
    outline: none;
    width: 200px;
    transition: border-color 0.2s, width 0.2s;
  }
  .search-wrap input:focus { border-color: var(--accent); width: 260px; }
  .search-wrap::before {
    content: 'âŒ•';
    position: absolute;
    left: 8px; top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 0.85rem;
    pointer-events: none;
  }

  .btn-refresh {
    background: transparent;
    border: 1px solid var(--border2);
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 5px;
  }
  .btn-refresh:hover { color: var(--text); border-color: var(--muted2); }
  .btn-refresh.spinning svg { animation: spin 0.6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Table wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-wrap {
    flex: 1;
    overflow: auto;
    padding: 0;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
  }
  thead {
    position: sticky;
    top: 0;
    z-index: 2;
  }
  thead th {
    background: var(--surface);
    padding: 10px 14px;
    text-align: left;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    font-weight: 500;
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
  }
  thead th:hover { color: var(--text); }
  thead th .sort-icon { opacity: 0.3; margin-left: 4px; }
  thead th.sort-asc .sort-icon,
  thead th.sort-desc .sort-icon { opacity: 1; color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  tbody tr:hover { background: rgba(255,255,255,0.025); }
  tbody td {
    padding: 9px 14px;
    color: var(--text);
    max-width: 280px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: middle;
    border-right: 1px solid rgba(30,32,40,0.5);
  }
  tbody td:last-child { border-right: none; }

  /* Cell type styling */
  .cell-uuid {
    font-size: 0.65rem;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
  }
  .cell-uuid .uuid-short {
    color: var(--accent2);
    font-weight: 500;
  }
  .cell-bool-true {
    color: var(--accent);
    font-weight: 500;
  }
  .cell-bool-false { color: var(--warn); }
  .cell-null { color: var(--muted2); font-style: italic; font-size: 0.65rem; }
  .cell-date { color: #a78bfa; font-size: 0.7rem; }
  .cell-json {
    color: #fbbf24;
    font-size: 0.65rem;
    cursor: pointer;
    text-decoration: underline dotted;
  }
  .cell-text-long {
    color: var(--text);
    cursor: pointer;
    text-decoration: underline dotted;
    text-decoration-color: var(--muted2);
  }
  .cell-text-long:hover {
    text-decoration-color: var(--accent);
    color: var(--accent);
  }
  .cell-number { color: var(--accent2); }
  .cell-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.65rem;
    font-weight: 500;
  }
  .badge-success { background: rgba(0,229,160,0.1); color: var(--accent); border: 1px solid rgba(0,229,160,0.2); }
  .badge-failed  { background: rgba(255,107,53,0.1); color: var(--warn); border: 1px solid rgba(255,107,53,0.2); }
  .badge-pending { background: rgba(255,255,255,0.05); color: var(--muted); border: 1px solid var(--border2); }
  .badge-running { background: rgba(0,153,255,0.1); color: var(--accent2); border: 1px solid rgba(0,153,255,0.2); }
  .badge-user    { background: rgba(0,153,255,0.08); color: var(--accent2); }
  .badge-assistant { background: rgba(0,229,160,0.08); color: var(--accent); }
  .badge-system  { background: rgba(255,255,255,0.05); color: var(--muted); }

  /* â”€â”€ Empty / loading / error states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .state-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 12px;
    color: var(--muted);
    font-size: 0.8rem;
  }
  .state-box .state-icon { font-size: 2rem; opacity: 0.3; }
  .state-box p { max-width: 320px; text-align: center; line-height: 1.6; }
  .state-box .state-err { color: var(--warn); font-size: 0.72rem; max-width: 380px; }

  /* Loading bar */
  .loading-bar {
    height: 2px;
    background: var(--border);
    position: relative;
    overflow: hidden;
  }
  .loading-bar::after {
    content: '';
    position: absolute;
    height: 100%;
    width: 40%;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: loadbar 1s ease-in-out infinite;
  }
  @keyframes loadbar {
    0% { left: -40%; }
    100% { left: 100%; }
  }

  /* â”€â”€ JSON viewer modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(3px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-backdrop.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 8px;
    width: 560px;
    max-width: 90vw;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
    transform: translateY(8px);
    transition: transform 0.2s;
  }
  .modal-backdrop.open .modal { transform: translateY(0); }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
  }
  .modal-header span {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
  }
  .modal-body pre.text-content {
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.8;
  }
  .modal-close {
    background: none; border: none;
    color: var(--muted); cursor: pointer;
    font-size: 1.2rem; line-height: 1;
    transition: color 0.15s;
  }
  .modal-close:hover { color: var(--text); }
  .modal-body {
    padding: 16px 18px;
    overflow-y: auto;
    flex: 1;
  }
  .modal-body pre {
    font-size: 0.72rem;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-all;
    color: #fbbf24;
  }

  /* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pagination {
    height: 44px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 8px;
    flex-shrink: 0;
    background: var(--surface);
  }
  .page-info { font-size: 0.68rem; color: var(--muted); margin-right: auto; }
  .page-btn {
    background: transparent;
    border: 1px solid var(--border2);
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.68rem;
    padding: 4px 10px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .page-btn:hover:not(:disabled) { color: var(--text); border-color: var(--muted2); }
  .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .page-btn.active { background: rgba(0,229,160,0.1); color: var(--accent); border-color: rgba(0,229,160,0.3); }

  /* â”€â”€ Scrollbars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted2); }

  /* â”€â”€ Connection banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .conn-banner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 20px;
    padding: 40px;
  }
  .conn-banner h2 {
    font-family: 'Syne', sans-serif;
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--text);
  }
  .conn-banner p { font-size: 0.78rem; color: var(--muted); text-align: center; max-width: 400px; line-height: 1.7; }
  .conn-banner .hint {
    font-size: 0.7rem;
    padding: 10px 16px;
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 5px;
    color: var(--muted);
    max-width: 500px;
    width: 100%;
    text-align: center;
  }
  .conn-banner .hint strong { color: var(--accent); }

  /* responsive */
  @media (max-width: 640px) {
    .sidebar { display: none; }
  }
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="logo">MRAG</div>
  <div class="topbar-sep"></div>
  <span class="topbar-label">Database Explorer</span>
  <div class="db-config">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-text" id="statusText">Loading...</span>
  </div>
</div>

<!-- Layout -->
<div class="layout" id="layoutArea" style="display:none">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-section-title">Tables</div>
      <div id="tableNav"></div>
    </div>
    <div class="sidebar-stats" id="sidebarStats"></div>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="table-toolbar" id="toolbar" style="display:none">
      <span class="table-title" id="toolbarTitle">â€”</span>
      <span class="row-count" id="toolbarCount">0 rows</span>
      <div class="search-wrap">
        <input type="text" id="searchInput" placeholder="filter rowsâ€¦">
      </div>
      <button class="btn-refresh" id="refreshBtn" onclick="refreshTable()">
        <svg id="refreshIcon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        Refresh
      </button>
    </div>

    <div id="loadingBar" class="loading-bar" style="display:none"></div>

    <div class="table-wrap" id="tableWrap">
      <!-- connection screen -->
      <div class="conn-banner" id="connBanner">
        <h2>Connecting to Database...</h2>
        <p>Fetching data from Docker containers automatically.</p>
        <div class="hint">
          Make sure <strong>dashboard_server.py</strong> is running on port 8080
        </div>
        <div class="hint" style="margin-top: 12px;">
          <strong>Quick Start:</strong> Run <code style="color: var(--accent);">python dashboard_server.py</code> in your project directory
        </div>
      </div>
    </div>

    <div class="pagination" id="pagination" style="display:none">
      <span class="page-info" id="pageInfo">Showing 0â€“0 of 0</span>
      <button class="page-btn" id="prevBtn" onclick="changePage(-1)">â† Prev</button>
      <span id="pageNums" style="display:flex;gap:4px"></span>
      <button class="page-btn" id="nextBtn" onclick="changePage(1)">Next â†’</button>
    </div>
  </div>
</div>

<!-- JSON modal -->
<div class="modal-backdrop" id="jsonModal" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-header">
      <span>JSON Value</span>
      <button class="modal-close" onclick="document.getElementById('jsonModal').classList.remove('open')">âœ•</button>
    </div>
    <div class="modal-body">
      <pre id="jsonModalContent"></pre>
    </div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABLES = [
  { name: 'users',                  icon: 'ğŸ‘¤' },
  { name: 'sessions',               icon: 'ğŸ”—' },
  { name: 'conversations',          icon: 'ğŸ’¬' },
  { name: 'messages',               icon: 'ğŸ“¨' },
  { name: 'agent_executions',       icon: 'ğŸ¤–' },
  { name: 'documents',              icon: 'ğŸ“„' },
  { name: 'conversation_summaries', icon: 'ğŸ“' },
  { name: 'user_long_term_memory',  icon: 'ğŸ§ ' },
];

let DB = {};          // { tableName: rowsArray }
let activeTable = null;
let sortCol = null;
let sortDir = 'asc';
let searchQuery = '';
let currentPage = 1;
const PAGE_SIZE = 50;
const BACKEND_URL = 'http://localhost:8080';

// Store cell data for safe modal display (avoids inline escaping issues)
let _cellDataStore = {};
let _cellDataId = 0;

// â”€â”€ Auto-connect on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  autoConnect();
});

async function autoConnect() {
  setStatus('connecting');
  try {
    const response = await fetch(`${BACKEND_URL}/api/db-snapshot`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    ingestData(data);
  } catch (err) {
    setStatus('error');
    showConnError(`Failed to connect: ${err.message}\n\nMake sure dashboard_server.py is running:\npython dashboard_server.py`);
  }
}

function ingestData(payload) {
  DB = {};
  for (const t of TABLES) {
    const rows = payload[t.name];
    DB[t.name] = Array.isArray(rows) ? rows : [];
  }
  setStatus('connected');
  document.getElementById('connBanner').style.display = 'none';
  document.getElementById('layoutArea').style.display = 'flex';
  buildSidebar();
  // Auto-select first non-empty table
  const first = TABLES.find(t => DB[t.name].length > 0) || TABLES[0];
  selectTable(first.name);
}

function showConnError(msg) {
  const b = document.getElementById('connBanner');
  b.innerHTML = `
    <h2>Connection Failed</h2>
    <p style="color:var(--warn);white-space:pre-wrap;font-family:'JetBrains Mono',monospace;font-size:0.7rem;max-width:500px;">${esc(msg)}</p>
    <button class="btn btn-primary" onclick="autoConnect()" style="padding:10px 24px;margin-top:12px">
      Retry Connection
    </button>
  `;
}

function setStatus(state) {
  const dot = document.getElementById('statusDot');
  const txt = document.getElementById('statusText');
  dot.className = 'status-dot ' + (state === 'connected' ? 'connected' : state === 'error' ? 'error' : '');
  txt.textContent = state === 'connected' ? 'Connected' : state === 'error' ? 'Connection Error' : 'Connectingâ€¦';
}

// â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSidebar() {
  const nav = document.getElementById('tableNav');
  nav.innerHTML = TABLES.map(t => `
    <div class="table-nav-item" id="nav-${t.name}" onclick="selectTable('${t.name}')">
      <span class="t-icon">${t.icon}</span>
      <span class="tname">${t.name}</span>
      <span class="table-badge">${DB[t.name].length}</span>
    </div>
  `).join('');

  const total = Object.values(DB).reduce((s, r) => s + r.length, 0);
  document.getElementById('sidebarStats').innerHTML = `
    <div class="stat-row"><span>Total rows</span><span>${total}</span></div>
    <div class="stat-row"><span>Tables</span><span>${TABLES.length}</span></div>
  `;
}

// â”€â”€ Table rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectTable(name) {
  activeTable = name;
  sortCol = null; sortDir = 'asc';
  searchQuery = '';
  currentPage = 1;
  document.getElementById('searchInput').value = '';

  document.querySelectorAll('.table-nav-item').forEach(el => el.classList.remove('active'));
  const nav = document.getElementById(`nav-${name}`);
  if (nav) nav.classList.add('active');

  document.getElementById('toolbar').style.display = 'flex';
  document.getElementById('pagination').style.display = 'flex';

  renderTable();
}

async function refreshTable() {
  if (!activeTable) return;
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  
  try {
    const response = await fetch(`${BACKEND_URL}/api/db-snapshot`);
    if (response.ok) {
      const data = await response.json();
      ingestData(data);
      selectTable(activeTable); // Re-select current table
    }
  } catch (err) {
    console.error('Refresh failed:', err);
  } finally {
    setTimeout(() => btn.classList.remove('spinning'), 400);
  }
}

document.getElementById('searchInput').addEventListener('input', (e) => {
  searchQuery = e.target.value.toLowerCase();
  currentPage = 1;
  renderTable();
});

function renderTable() {
  if (!activeTable) return;
  const rows = DB[activeTable] || [];

  // Reset cell data store each render to avoid memory leak
  _cellDataStore = {};
  _cellDataId = 0;

  // â”€â”€ derive columns â”€â”€
  const allCols = new Set();
  rows.forEach(r => Object.keys(r).forEach(k => allCols.add(k)));
  const cols = [...allCols];

  // â”€â”€ filter â”€â”€
  let filtered = rows;
  if (searchQuery) {
    filtered = rows.filter(r =>
      cols.some(c => {
        const v = r[c];
        if (v === null || v === undefined) return false;
        return String(typeof v === 'object' ? JSON.stringify(v) : v)
          .toLowerCase().includes(searchQuery);
      })
    );
  }

  // â”€â”€ sort â”€â”€
  if (sortCol) {
    filtered = [...filtered].sort((a, b) => {
      let va = a[sortCol], vb = b[sortCol];
      if (va === null || va === undefined) va = '';
      if (vb === null || vb === undefined) vb = '';
      const cmp = String(va).localeCompare(String(vb), undefined, { numeric: true });
      return sortDir === 'asc' ? cmp : -cmp;
    });
  }

  // â”€â”€ pagination â”€â”€
  const total = filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  currentPage = Math.min(currentPage, totalPages);
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = filtered.slice(start, start + PAGE_SIZE);

  // â”€â”€ toolbar â”€â”€
  document.getElementById('toolbarTitle').innerHTML =
    `<span class="schema-prefix">public.</span>${activeTable}`;
  document.getElementById('toolbarCount').textContent =
    `${total} / ${rows.length} rows`;

  // â”€â”€ table HTML â”€â”€
  if (cols.length === 0) {
    document.getElementById('tableWrap').innerHTML =
      `<div class="state-box"><div class="state-icon">â—‹</div><p>No data in <strong>${activeTable}</strong></p></div>`;
  } else {
    const th = cols.map(c => {
      const cls = sortCol === c ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : '';
      return `<th class="${cls}" onclick="sortBy('${c}')">
        ${c} <span class="sort-icon">${sortDir === 'asc' && sortCol === c ? 'â†‘' : 'â†“'}</span>
      </th>`;
    }).join('');

    const trs = pageRows.map(row => {
      const tds = cols.map(c => `<td>${renderCell(c, row[c])}</td>`).join('');
      return `<tr>${tds}</tr>`;
    }).join('');

    document.getElementById('tableWrap').innerHTML = pageRows.length === 0
      ? `<div class="state-box"><div class="state-icon">âŒ€</div><p>No rows match your filter.</p></div>`
      : `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
  }

  // â”€â”€ pagination controls â”€â”€
  const pi = document.getElementById('pageInfo');
  pi.textContent = `Showing ${start + 1}â€“${Math.min(start + PAGE_SIZE, total)} of ${total}`;

  const pn = document.getElementById('pageNums');
  pn.innerHTML = '';
  const window_ = 3;
  for (let p = Math.max(1, currentPage - window_); p <= Math.min(totalPages, currentPage + window_); p++) {
    const b = document.createElement('button');
    b.className = 'page-btn' + (p === currentPage ? ' active' : '');
    b.textContent = p;
    b.onclick = () => { currentPage = p; renderTable(); };
    pn.appendChild(b);
  }

  document.getElementById('prevBtn').disabled = currentPage <= 1;
  document.getElementById('nextBtn').disabled = currentPage >= totalPages;
}

function sortBy(col) {
  if (sortCol === col) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; }
  else { sortCol = col; sortDir = 'asc'; }
  renderTable();
}

function changePage(delta) {
  currentPage += delta;
  renderTable();
}

// â”€â”€ Cell rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCell(col, val) {
  if (val === null || val === undefined) return `<span class="cell-null">null</span>`;

  // Boolean
  if (val === true || val === false) {
    return val
      ? `<span class="cell-bool-true">âœ“ true</span>`
      : `<span class="cell-bool-false">âœ— false</span>`;
  }

  // Status badge
  if (col === 'status') {
    const cls = { success:'badge-success', failed:'badge-failed', pending:'badge-pending', running:'badge-running' }[val] || 'badge-pending';
    return `<span class="cell-badge ${cls}">${esc(val)}</span>`;
  }

  // Role badge
  if (col === 'role') {
    const cls = { user:'badge-user', assistant:'badge-assistant', system:'badge-system' }[val] || '';
    return `<span class="cell-badge ${cls}">${esc(val)}</span>`;
  }

  // UUID columns
  const uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (typeof val === 'string' && uuidRe.test(val)) {
    return `<span class="cell-uuid"><span class="uuid-short">${val.slice(0, 8)}</span>â€¦${val.slice(-4)}</span>`;
  }

  // Datetime
  if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(val)) {
    const d = new Date(val);
    const fmt = isNaN(d) ? val : d.toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    return `<span class="cell-date" title="${esc(val)}">${fmt}</span>`;
  }

  // JSON object/array
  if (typeof val === 'object') {
    const json = JSON.stringify(val);
    const preview = json.length > 40 ? json.slice(0, 40) + 'â€¦' : json;
    const id = _storeCellData(json, 'json');
    return `<span class="cell-json" onclick="showCellData(${id})">${esc(preview)}</span>`;
  }

  // Number
  if (typeof val === 'number') {
    return `<span class="cell-number">${val}</span>`;
  }

  // Long text â€” clickable to show full content
  const s = String(val);
  if (s.length > 80) {
    const id = _storeCellData(s, 'text', col);
    return `<span class="cell-text-long" onclick="showCellData(${id})">${esc(s.slice(0, 80))}â€¦</span>`;
  }

  return esc(s);
}

function _storeCellData(value, type, colName) {
  const id = ++_cellDataId;
  _cellDataStore[id] = { value, type, colName };
  return id;
}

function showCellData(id) {
  const entry = _cellDataStore[id];
  if (!entry) return;
  const pre = document.getElementById('jsonModalContent');
  const title = document.querySelector('.modal-header span');

  if (entry.type === 'json') {
    title.textContent = 'JSON Value';
    pre.className = '';
    try {
      pre.textContent = JSON.stringify(JSON.parse(entry.value), null, 2);
    } catch {
      pre.textContent = entry.value;
    }
  } else {
    title.textContent = entry.colName || 'Full Content';
    pre.className = 'text-content';
    pre.textContent = entry.value;
  }
  document.getElementById('jsonModal').classList.add('open');
}

function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// Legacy â€” kept for backward compat, delegates to new store
function showJson(jsonStr) {
  const id = _storeCellData(jsonStr, 'json');
  showCellData(id);
}

function closeModal(e) {
  if (e.target.id === 'jsonModal') {
    document.getElementById('jsonModal').classList.remove('open');
  }
}
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('jsonModal').classList.remove('open');
});
</script>
</body>
</html>
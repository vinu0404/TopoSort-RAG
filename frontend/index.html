<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MRAG</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #fff;
    color: #000;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .auth-overlay {
    position: fixed; inset: 0;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .auth-overlay.hidden { display: none; }
  .auth-card {
    width: 320px;
    max-width: 90vw;
  }
  .auth-card h2 {
    font-size: 1.5rem;
    margin-bottom: 24px;
    font-weight: 600;
  }
  .auth-tabs {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    border-bottom: 1px solid #e0e0e0;
  }
  .auth-tab {
    padding: 8px 0;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    font-size: 0.9rem;
    cursor: pointer;
    color: #999;
  }
  .auth-tab.active {
    color: #000;
    border-bottom-color: #000;
  }
  .auth-field {
    margin-bottom: 16px;
  }
  .auth-field label {
    display: block;
    font-size: 0.85rem;
    margin-bottom: 6px;
    color: #666;
  }
  .auth-field input {
    width: 100%;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 0.9rem;
    outline: none;
  }
  .auth-field input:focus {
    border-color: #000;
  }
  .auth-btn {
    width: 100%;
    padding: 12px;
    background: #000;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
    margin-top: 8px;
  }
  .auth-btn:hover { opacity: 0.8; }
  .auth-btn:disabled { opacity: 0.3; }
  .auth-error {
    color: #ff3b30;
    font-size: 0.85rem;
    margin-top: 12px;
    min-height: 20px;
  }

  /* â”€â”€ Connections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .connections-section { margin-top: 16px; }
  .connections-section h3 { font-size: 0.85rem; margin-bottom: 8px; }
  .conn-list { display: flex; flex-direction: column; gap: 6px; }
  .conn-item {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 10px; border-radius: 8px;
    background: #f5f5f7; font-size: 0.8rem;
  }
  .conn-item .conn-icon { font-size: 1.1rem; flex-shrink: 0; }
  .conn-item .conn-info { flex: 1; min-width: 0; }
  .conn-item .conn-label {
    font-weight: 600; font-size: 0.78rem;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .conn-item .conn-status {
    font-size: 0.65rem; color: #666;
  }
  .conn-item .conn-status.active { color: #34c759; }
  .conn-item .conn-status.error { color: #ff3b30; }
  .conn-item .conn-disconnect {
    background: none; border: none; cursor: pointer;
    color: #999; font-size: 0.75rem; padding: 2px 6px;
    border-radius: 4px;
  }
  .conn-item .conn-disconnect:hover { background: #fee; color: #ff3b30; }
  .conn-btn {
    display: flex; align-items: center; gap: 6px;
    width: 100%; padding: 8px 12px; margin-top: 4px;
    border: 1px dashed #ccc; border-radius: 8px;
    background: none; cursor: pointer;
    font-size: 0.78rem; color: #666;
    transition: all 0.15s;
  }
  .conn-btn:hover { border-color: #007aff; color: #007aff; background: #f0f5ff; }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid #e0e0e0;
  }
  .header h1 {
    font-size: 1rem;
    font-weight: 600;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .user-info {
    font-size: 0.85rem;
    color: #666;
  }
  .btn-logout {
    background: none;
    border: none;
    font-size: 0.85rem;
    color: #666;
    cursor: pointer;
    text-decoration: underline;
  }
  .btn-logout:hover { color: #000; }
  
  .health-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ccc;
    transition: background 0.3s;
  }
  .health-dot.ok {
    background: #4ade80;
  }
  .health-dot.err {
    background: #ff3b30;
  }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .container {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sidebar {
    width: 240px;
    border-right: 1px solid #e0e0e0;
    padding: 24px;
    overflow-y: auto;
  }
  .sidebar h3 {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #999;
    margin-bottom: 12px;
  }
  .upload-zone {
    border: 1px dashed #ccc;
    border-radius: 4px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    margin-bottom: 24px;
    position: relative;
  }
  .upload-zone:hover {
    border-color: #000;
    background: #fafafa;
  }
  .upload-zone input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }
  .upload-zone p {
    font-size: 0.85rem;
    color: #666;
  }
  .upload-status {
    font-size: 0.8rem;
    color: #666;
    margin-top: 8px;
    min-height: 18px;
  }

  /* â”€â”€ Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pipeline-section {
    margin-top: 24px;
    display: none;
  }
  .pipeline-section.visible {
    display: block;
  }
  .pipeline {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .pipeline-agent {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: #f5f5f5;
    border-radius: 4px;
    font-size: 0.85rem;
  }
  .pipeline-agent .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ccc;
    flex-shrink: 0;
  }
  .pipeline-agent .dot.active {
    background: #000;
    animation: pulse 1s infinite;
  }
  .pipeline-agent .dot.done {
    background: #4ade80;
    animation: none;
  }
  .pipeline-agent .dot.error {
    background: #ff3b30;
    animation: none;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* â”€â”€ Info section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .info-section {
    margin-top: 24px;
  }
  .info-section p {
    font-size: 0.8rem;
    color: #666;
    line-height: 1.6;
    margin-bottom: 8px;
  }
  .info-section ul {
    font-size: 0.8rem;
    color: #666;
    line-height: 1.6;
    padding-left: 20px;
  }

  /* â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chat {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
  }
  .msg {
    margin-bottom: 16px;
    max-width: 600px;
  }
  .msg.user {
    margin-left: auto;
  }
  .msg-label {
    font-size: 0.75rem;
    color: #999;
    margin-bottom: 4px;
  }
  .msg-content {
    padding: 12px 16px;
    border-radius: 4px;
    font-size: 0.9rem;
    line-height: 1.5;
  }
  .msg.user .msg-content {
    background: #000;
    color: #fff;
  }
  .msg.assistant .msg-content {
    background: #f5f5f5;
    color: #000;
  }
  .msg.system {
    text-align: center;
    color: #999;
    font-size: 0.85rem;
  }
  
  .inline-ref {
    color: #666;
    cursor: pointer;
    text-decoration: none;
    font-weight: 500;
    border-bottom: 1px dotted #999;
  }
  .inline-ref:hover {
    color: #000;
    border-bottom-color: #000;
  }

  /* â”€â”€ Welcome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .welcome {
    text-align: center;
    padding: 48px 24px;
    color: #999;
  }
  .welcome h2 {
    font-size: 1.5rem;
    color: #000;
    margin-bottom: 8px;
    font-weight: 600;
  }
  .welcome p {
    font-size: 0.9rem;
    margin-bottom: 24px;
  }
  .examples {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }
  .example {
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    color: #666;
  }
  .example:hover {
    border-color: #000;
    color: #000;
  }

  /* â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .input-area {
    padding: 16px 24px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }
  .input-area textarea {
    flex: 1;
    resize: none;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 10px 12px;
    font-size: 0.9rem;
    font-family: inherit;
    outline: none;
    min-height: 44px;
    max-height: 120px;
  }
  .input-area textarea:focus {
    border-color: #000;
  }
  .btn-send {
    background: #000;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 10px 20px;
    font-size: 0.9rem;
    cursor: pointer;
    white-space: nowrap;
  }
  .btn-send:hover { opacity: 0.8; }
  .btn-send:disabled { opacity: 0.3; }

  .typing {
    display: none;
    gap: 4px;
    padding: 12px 16px;
    background: #f5f5f5;
    border-radius: 4px;
    width: fit-content;
    margin-bottom: 16px;
  }
  .typing.visible { display: flex; }
  .typing span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #999;
    animation: bounce 1.4s infinite;
  }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-4px); }
  }

  /* â”€â”€ HITL Approval Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hitl-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    animation: fadeIn 0.2s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .hitl-card {
    background: #fff;
    border-radius: 8px;
    padding: 28px 32px;
    width: 440px;
    max-width: 90vw;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  }
  .hitl-card h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .hitl-card h3::before {
    content: '\26A0';
    font-size: 1.3rem;
  }
  .hitl-card .hitl-desc {
    font-size: 0.88rem;
    color: #444;
    margin-bottom: 14px;
    line-height: 1.5;
  }
  .hitl-card .hitl-tools {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 16px;
  }
  .hitl-card .hitl-tool-tag {
    background: #fee2e2;
    color: #b91c1c;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.78rem;
    font-weight: 500;
  }
  .hitl-card .hitl-agent-tag {
    background: #e0e7ff;
    color: #3730a3;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.78rem;
    font-weight: 500;
  }
  .hitl-card label {
    display: block;
    font-size: 0.82rem;
    color: #666;
    margin-bottom: 5px;
  }
  .hitl-card textarea {
    width: 100%;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 8px 10px;
    font-size: 0.85rem;
    font-family: inherit;
    resize: none;
    outline: none;
    min-height: 48px;
    margin-bottom: 16px;
  }
  .hitl-card textarea:focus {
    border-color: #000;
  }
  .hitl-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .hitl-btn {
    padding: 9px 22px;
    border: none;
    border-radius: 4px;
    font-size: 0.88rem;
    cursor: pointer;
    font-weight: 500;
  }
  .hitl-btn.approve {
    background: #000;
    color: #fff;
  }
  .hitl-btn.approve:hover { opacity: 0.8; }
  .hitl-btn.deny {
    background: #f5f5f5;
    color: #333;
    border: 1px solid #e0e0e0;
  }
  .hitl-btn.deny:hover { background: #eee; }
  .hitl-timer {
    font-size: 0.78rem;
    color: #999;
    margin-top: 10px;
    text-align: right;
  }

  /* â”€â”€ HITL pipeline badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pipeline-agent .dot.hitl {
    background: #f59e0b;
    animation: pulse 1s infinite;
  }

  @media (max-width: 768px) {
    .sidebar { display: none; }
  }
</style>
</head>
<body>

<!-- â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-card">
    <h2>MRAG</h2>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="switchTab('login')">Login</button>
      <button class="auth-tab" id="tabRegister" onclick="switchTab('register')">Register</button>
    </div>

    <div id="loginForm">
      <div class="auth-field">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="you@example.com">
      </div>
      <div class="auth-field">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="Enter password">
      </div>
      <button class="auth-btn" id="loginBtn" onclick="doLogin()">Login</button>
    </div>

    <div id="registerForm" style="display:none;">
      <div class="auth-field">
        <label>Username</label>
        <input type="text" id="regUsername" placeholder="Your name">
      </div>
      <div class="auth-field">
        <label>Email</label>
        <input type="email" id="regEmail" placeholder="you@example.com">
      </div>
      <div class="auth-field">
        <label>Password</label>
        <input type="password" id="regPassword" placeholder="Min 4 characters">
      </div>
      <button class="auth-btn" id="regBtn" onclick="doRegister()">Create Account</button>
    </div>

    <div class="auth-error" id="authError"></div>
  </div>
</div>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="header">
  <h1>MRAG</h1>
  <div class="header-right">
    <span class="user-info" id="userName">User</span>
    <button class="btn-logout" onclick="doLogout()">Logout</button>
    <div class="health-dot" id="healthDot" title="Server health"></div>
  </div>
</div>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="container">
  <aside class="sidebar">
    <h3>Upload</h3>
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept=".pdf,.txt,.md,.docx,.csv,.json">
      <p>Drop file or click</p>
    </div>
    <div class="upload-status" id="uploadStatus"></div>

    <div class="pipeline-section" id="pipelineSection">
      <h3>Agent Pipeline</h3>
      <div class="pipeline" id="pipeline"></div>
    </div>

    <div class="info-section">
      <h3>Info</h3>
      <p><strong>Agents:</strong> RAG, Code, Mail, Web Search</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li>Streaming responses</li>
        <li>Document upload (RAG)</li>
        <li>Long-term memory</li>
        <li>Multi-agent orchestration</li>
      </ul>
    </div>

    <div class="connections-section">
      <h3>Connections</h3>
      <div class="conn-list" id="connList">
        <!-- Populated by JS -->
      </div>
    </div>
  </aside>

  <main class="chat">
    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <h2>Multi-Agentic RAG</h2>
        <p>Ask anything</p>
        <div class="examples">
          <div class="example" onclick="fillQuery('What was our Q3 revenue?')">Q3 revenue</div>
          <div class="example" onclick="fillQuery('Search for AI trends')">AI trends</div>
          <div class="example" onclick="fillQuery('Write Python code')">Code</div>
        </div>
      </div>
    </div>

    <div class="typing" id="typingIndicator">
      <span></span><span></span><span></span>
    </div>

    <div class="input-area">
      <textarea id="queryInput" placeholder="Ask anything..." rows="1"></textarea>
      <button class="btn-send" id="sendBtn" onclick="sendQuery()">Send</button>
    </div>
  </main>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BASE = window.location.protocol === 'file:' ? 'http://127.0.0.1:8000' : window.location.origin;
const API = `${BASE}/api/v1`;

let currentUser = null;
let currentSessionId = null;
let isProcessing = false;

const authOverlay = document.getElementById('authOverlay');
const authError = document.getElementById('authError');
const messagesEl = document.getElementById('messages');
const welcomeEl = document.getElementById('welcome');
const queryInput = document.getElementById('queryInput');
const sendBtn = document.getElementById('sendBtn');
const userNameEl = document.getElementById('userName');
const healthDot = document.getElementById('healthDot');
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const uploadStatus = document.getElementById('uploadStatus');
const pipelineSection = document.getElementById('pipelineSection');
const pipelineEl = document.getElementById('pipeline');
const typingInd = document.getElementById('typingIndicator');

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getStoredAuth() {
  try {
    const raw = localStorage.getItem('mrag_auth');
    return raw ? JSON.parse(raw) : null;
  } catch { return null; }
}

function setStoredAuth(data) {
  localStorage.setItem('mrag_auth', JSON.stringify(data));
}

function clearStoredAuth() {
  localStorage.removeItem('mrag_auth');
}

function authHeaders() {
  if (!currentUser) return {};
  return { 'Authorization': `Bearer ${currentUser.token}` };
}

function switchTab(tab) {
  document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
  document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
  document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
  authError.textContent = '';
}

async function doRegister() {
  const username = document.getElementById('regUsername').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  authError.textContent = '';

  if (!username || !email || !password) {
    authError.textContent = 'All fields required';
    return;
  }
  if (password.length < 4) {
    authError.textContent = 'Password too short';
    return;
  }

  document.getElementById('regBtn').disabled = true;
  try {
    const r = await fetch(`${API}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, email, password }),
    });
    const data = await r.json();
    if (!r.ok) {
      authError.textContent = data.detail || 'Registration failed';
      return;
    }
    onLoginSuccess(data);
  } catch (err) {
    authError.textContent = `Error: ${err.message}`;
  } finally {
    document.getElementById('regBtn').disabled = false;
  }
}

async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  authError.textContent = '';

  if (!email || !password) {
    authError.textContent = 'Email and password required';
    return;
  }

  document.getElementById('loginBtn').disabled = true;
  try {
    const r = await fetch(`${API}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    const data = await r.json();
    if (!r.ok) {
      authError.textContent = data.detail || 'Login failed';
      return;
    }
    onLoginSuccess(data);
  } catch (err) {
    authError.textContent = `Error: ${err.message}`;
  } finally {
    document.getElementById('loginBtn').disabled = false;
  }
}

function onLoginSuccess(data) {
  currentUser = data;
  setStoredAuth(data);
  authOverlay.classList.add('hidden');
  userNameEl.textContent = data.display_name || 'User';
  currentSessionId = null; // Let backend create new session
  loadConnections();
}

function doLogout() {
  currentUser = null;
  currentSessionId = null;
  clearStoredAuth();
  authOverlay.classList.remove('hidden');
  messagesEl.innerHTML = '';
  messagesEl.appendChild(welcomeEl);
  welcomeEl.style.display = '';
  document.getElementById('connList').innerHTML = '';
}

// â”€â”€â”€ Connections (OAuth) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROVIDER_ICONS = {
  gmail: 'ðŸ“§', slack: 'ðŸ’¬', notion: 'ðŸ“', github: 'ðŸ™',
};
const PROVIDER_LABELS = {
  gmail: 'Gmail', slack: 'Slack', notion: 'Notion', github: 'GitHub',
};

async function loadConnections() {
  const connList = document.getElementById('connList');
  if (!connList || !currentUser) return;
  connList.innerHTML = '<div style="color:#888;font-size:0.85em">Loadingâ€¦</div>';

  try {
    const [provRes, connRes] = await Promise.all([
      fetch(`${API}/connectors/providers`),
      fetch(`${API}/connectors/connections`, { headers: authHeaders() }),
    ]);
    const providers = provRes.ok ? await provRes.json() : [];
    const connections = connRes.ok ? await connRes.json() : [];

    const connByProvider = {};
    connections.forEach(c => { connByProvider[c.provider] = c; });

    let html = '';
    providers.forEach(p => {
      const conn = connByProvider[p.name];
      const icon = PROVIDER_ICONS[p.name] || 'ðŸ”—';
      const label = PROVIDER_LABELS[p.name] || p.display_name;
      if (conn) {
        html += `
          <div class="conn-item">
            <span class="conn-icon">${icon}</span>
            <div class="conn-info">
              <span class="conn-label">${label}</span>
              <span class="conn-status connected">${conn.account_label || 'Connected'}</span>
            </div>
            <button class="conn-disconnect" onclick="disconnectConnection('${conn.id}')" title="Disconnect">âœ•</button>
          </div>`;
      } else {
        html += `
          <div class="conn-item">
            <span class="conn-icon">${icon}</span>
            <div class="conn-info">
              <span class="conn-label">${label}</span>
              <span class="conn-status">Not connected</span>
            </div>
            <button class="conn-btn" onclick="connectProvider('${p.name}')">Connect</button>
          </div>`;
      }
    });

    connList.innerHTML = html || '<div style="color:#888;font-size:0.85em">No connectors available</div>';
  } catch (err) {
    connList.innerHTML = '<div style="color:#f87171;font-size:0.85em">Failed to load</div>';
    console.error('loadConnections error:', err);
  }
}

function connectProvider(provider) {
  fetch(`${API}/connectors/${provider}/auth-url`, { headers: authHeaders() })
    .then(r => r.json())
    .then(data => {
      if (data.auth_url) {
        const w = 500, h = 600;
        const left = (screen.width - w) / 2, top = (screen.height - h) / 2;
        window.open(data.auth_url, 'oauth_popup',
          `width=${w},height=${h},left=${left},top=${top},toolbar=no,menubar=no`);
      }
    })
    .catch(err => console.error('connectProvider error:', err));
}

async function disconnectConnection(connectionId) {
  try {
    await fetch(`${API}/connectors/connections/${connectionId}`, {
      method: 'DELETE',
      headers: authHeaders(),
    });
    loadConnections();
  } catch (err) {
    console.error('disconnectConnection error:', err);
  }
}

// Listen for OAuth popup postMessage callback
window.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'oauth-callback') {
    if (event.data.success) {
      loadConnections();
    } else {
      console.error('OAuth callback error:', event.data.error);
    }
  }
});

// Init
(function() {
  const stored = getStoredAuth();
  if (stored && stored.token) {
    currentUser = stored;
    authOverlay.classList.add('hidden');
    userNameEl.textContent = stored.display_name || 'User';
    loadConnections();
  }
})();

document.getElementById('loginPassword').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});
document.getElementById('regPassword').addEventListener('keydown', e => {
  if (e.key === 'Enter') doRegister();
});

// â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkHealth() {
  try {
    const r = await fetch(`${API}/health`);
    healthDot.className = r.ok ? 'health-dot ok' : 'health-dot err';
    healthDot.title = r.ok ? 'Server running' : 'Server error';
  } catch {
    healthDot.className = 'health-dot err';
    healthDot.title = 'Server unreachable';
  }
}
checkHealth();
setInterval(checkHealth, 15000);

// â”€â”€ Examples â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fillQuery(text) {
  queryInput.value = text;
  queryInput.focus();
}

// â”€â”€ Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPipeline(agents) {
  pipelineSection.classList.add('visible');
  pipelineEl.innerHTML = agents.map(a => `
    <div class="pipeline-agent" data-agent="${a.agent_id || a.agent_name}">
      <div class="dot active"></div>
      <span>${a.agent_name}</span>
    </div>
  `).join('');
}

function updatePipelineAgent(agentId, done) {
  const el = pipelineEl.querySelector(`[data-agent="${agentId}"] .dot`);
  if (el) {
    el.classList.remove('active');
    el.classList.add(done ? 'done' : 'error');
  }
}

function clearPipeline() {
  pipelineSection.classList.remove('visible');
  pipelineEl.innerHTML = '';
}

// â”€â”€ Textarea auto-resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
queryInput.addEventListener('input', () => {
  queryInput.style.height = 'auto';
  queryInput.style.height = Math.min(queryInput.scrollHeight, 120) + 'px';
});
queryInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendQuery();
  }
});

// â”€â”€ File upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
uploadZone.addEventListener('dragover', (e) => e.preventDefault());
uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  if (e.dataTransfer.files.length) uploadFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files.length) uploadFile(fileInput.files[0]);
});

async function uploadFile(file) {
  if (!currentUser) { authOverlay.classList.remove('hidden'); return; }
  uploadStatus.textContent = `Uploading ${file.name}...`;
  const form = new FormData();
  form.append('user_id', currentUser.user_id);
  form.append('file', file);
  try {
    const r = await fetch(`${API}/documents/upload`, {
      method: 'POST',
      headers: authHeaders(),
      body: form,
    });
    const data = await r.json();
    if (r.ok) {
      uploadStatus.textContent = `Uploaded: ${file.name}`;
      addSystemMessage(`Document uploaded`);
    } else if (r.status === 401) {
      doLogout();
    } else {
      uploadStatus.textContent = `Error: ${data.detail || 'Failed'}`;
    }
  } catch (err) {
    uploadStatus.textContent = `Error: ${err.message}`;
  }
  fileInput.value = '';
}

// â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addUserMessage(text) {
  welcomeEl.style.display = 'none';
  const div = document.createElement('div');
  div.className = 'msg user';
  div.innerHTML = `
    <div class="msg-label">You</div>
    <div class="msg-content">${escapeHtml(text)}</div>
  `;
  messagesEl.appendChild(div);
  scrollToBottom();
}

function addSystemMessage(text) {
  const div = document.createElement('div');
  div.className = 'msg system';
  div.textContent = text;
  messagesEl.appendChild(div);
  scrollToBottom();
}

function createAssistantMessage() {
  welcomeEl.style.display = 'none';
  const div = document.createElement('div');
  div.className = 'msg assistant';
  div.innerHTML = `
    <div class="msg-label">Assistant</div>
    <div class="msg-content"></div>
  `;
  messagesEl.appendChild(div);
  scrollToBottom();
  return div;
}

function appendToAssistant(msgEl, text) {
  const content = msgEl.querySelector('.msg-content');
  content.textContent += text;
  scrollToBottom();
}

function finalizeAssistant(msgEl, sources) {
  const content = msgEl.querySelector('.msg-content');
  let rawText = content.textContent || '';

  // Parse any trailing "Sources:" block
  const sourcesMatch = rawText.match(/\n\n?Sources:\n([\s\S]*)$/);
  if (sourcesMatch) {
    const block = sourcesMatch[1];
    const lines = block.trim().split('\n');
    for (const line of lines) {
      // FIX: Use a greedy match for the URL to consume the full URL including
      // any internal parentheses, then strip only the final closing ')'.
      // Pattern: [N] title (url)  â€” the url may itself contain '(' and ')'
      const m = line.match(/^\[(\d+)\]\s*(.+?)(?:\s*\((.+)\))?\s*$/);
      if (m) {
        const idx = parseInt(m[1]) - 1;
        // Strip any accidental trailing ')' or whitespace from the captured URL
        const rawUrl = m[3] ? m[3].replace(/\)+$/, '').trim() : null;
        if (!sources[idx]) {
          sources[idx] = { source: m[2].trim(), url: rawUrl };
        } else if (!sources[idx].url && rawUrl) {
          sources[idx].url = rawUrl;
        }
      }
    }
    rawText = rawText.slice(0, sourcesMatch.index).trimEnd();
  }

  // Escape HTML and make [1], [2] etc clickable
  const escaped = rawText
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  
  const withRefs = escaped.replace(/\[(\d+)\]/g, (match, num) => {
    const idx = parseInt(num) - 1;
    const src = sources[idx];
    if (src && src.url) {
      return `<a class="inline-ref" href="${src.url}" target="_blank" title="${src.source || src.url}">[${num}]</a>`;
    }
    return `<span class="inline-ref" title="Source ${num}">[${num}]</span>`;
  });
  
  content.innerHTML = withRefs;
  scrollToBottom();
}

function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function escapeHtml(text) {
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// â”€â”€ Send query â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendQuery() {
  const query = queryInput.value.trim();
  if (!query || isProcessing) return;
  if (!currentUser) { authOverlay.classList.remove('hidden'); return; }

  isProcessing = true;
  sendBtn.disabled = true;
  queryInput.value = '';
  queryInput.style.height = 'auto';

  addUserMessage(query);
  clearPipeline();

  await sendStreaming(query);

  isProcessing = false;
  sendBtn.disabled = false;
  queryInput.focus();
}

async function sendStreaming(query) {
  typingInd.classList.add('visible');
  let msgEl = null;
  let sources = [];

  try {
    const response = await fetch(`${API}/query/stream`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({ 
        query, 
        user_id: currentUser.user_id,
        session_id: currentSessionId
      }),
    });

    if (!response.ok) {
      typingInd.classList.remove('visible');
      if (response.status === 401) {
        doLogout();
        return;
      }
      const err = await response.json();
      addSystemMessage(`Error: ${err.detail || response.statusText}`);
      return;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      let eventType = null;
      for (const line of lines) {
        if (line.startsWith('event: ')) {
          eventType = line.slice(7).trim();
        } else if (line.startsWith('data: ') && eventType) {
          const data = line.slice(6);
          handleSSE(eventType, data);
          eventType = null;
        }
      }
    }

    typingInd.classList.remove('visible');
  } catch (err) {
    typingInd.classList.remove('visible');
    addSystemMessage(`Error: ${err.message}`);
  }

  function handleSSE(event, rawData) {
    let data;
    try { data = JSON.parse(rawData); } catch { data = rawData; }

    switch (event) {
      case 'status':
        if (data.phase === 'planning') {
          addSystemMessage('Planning...');
        } else if (data.phase === 'executing') {
          addSystemMessage('Running agents...');
        } else if (data.phase === 'composing') {
          typingInd.classList.remove('visible');
          if (!msgEl) msgEl = createAssistantMessage();
        }
        break;

      case 'plan':
        if (data.agents) showPipeline(data.agents);
        if (data.intent) addSystemMessage(`Intent: ${data.intent}`);
        break;

      case 'token':
        if (!msgEl) {
          typingInd.classList.remove('visible');
          msgEl = createAssistantMessage();
        }
        appendToAssistant(msgEl, data.text || '');
        break;

      case 'agent_result':
        updatePipelineAgent(data.agent, data.done);
        if (data.sources && Array.isArray(data.sources)) {
          sources.push(...data.sources);
        }
        break;

      case 'done':
        typingInd.classList.remove('visible');
        if (msgEl) finalizeAssistant(msgEl, sources);
        break;

      case 'error':
        typingInd.classList.remove('visible');
        addSystemMessage(`Error: ${data.message || data}`);
        break;

      case 'hitl_required':
        showHitlDialog(data);
        break;

      case 'hitl_approved':
        dismissHitlDialog();
        updatePipelineAgent(data.agent_id, false);
        if (data.instructions) {
          addSystemMessage(`Approved with instruction: "${data.instructions}" â€” ${data.agent_id} is running...`);
        } else {
          addSystemMessage(`Approved â€” ${data.agent_id} is running...`);
        }
        break;

      case 'hitl_denied':
        dismissHitlDialog();
        updatePipelineAgent(data.agent_id, false);
        addSystemMessage(`Denied â€” ${data.agent_id} was skipped.`);
        break;

      case 'hitl_timeout':
        dismissHitlDialog();
        updatePipelineAgent(data.agent_id, false);
        addSystemMessage(`Approval timed out â€” ${data.agent_id} was skipped.`);
        break;
    }
  }
}

// â”€â”€ HITL Approval Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let hitlTimerInterval = null;

function showHitlDialog(data) {
  dismissHitlDialog(); // remove any previous dialog

  // Mark agent in pipeline as waiting for approval
  const agentDot = pipelineEl.querySelector(`[data-agent="${data.agent_id}"] .dot`);
  if (agentDot) {
    agentDot.classList.remove('active');
    agentDot.classList.add('hitl');
  }

  const toolTags = (data.tool_names || []).map(t =>
    `<span class="hitl-tool-tag">${escapeHtml(t)}</span>`
  ).join('');

  const overlay = document.createElement('div');
  overlay.className = 'hitl-overlay';
  overlay.id = 'hitlOverlay';
  overlay.innerHTML = `
    <div class="hitl-card">
      <h3>Approval Required</h3>
      <div class="hitl-desc">
        <span class="hitl-agent-tag">${escapeHtml(data.agent_name)}</span>
        wants to use tools that require your approval.
      </div>
      <div style="font-size:0.85rem;color:#333;margin-bottom:12px;line-height:1.5">
        <strong>Task:</strong> ${escapeHtml(data.task_description || '')}
      </div>
      <div class="hitl-tools">${toolTags}</div>
      <label>Instructions (optional)</label>
      <textarea id="hitlInstructions" placeholder="Add constraints, e.g. 'only search in English'..."></textarea>
      <div class="hitl-actions">
        <button class="hitl-btn deny" onclick="respondHitl('${data.request_id}', 'denied')">Deny</button>
        <button class="hitl-btn approve" onclick="respondHitl('${data.request_id}', 'approved')">Approve</button>
      </div>
      <div class="hitl-timer" id="hitlTimer"></div>
    </div>
  `;
  document.body.appendChild(overlay);

  // Countdown timer
  const timeout = data.timeout_seconds || 120;
  let remaining = timeout;
  const timerEl = document.getElementById('hitlTimer');
  timerEl.textContent = `Auto-deny in ${remaining}s`;
  hitlTimerInterval = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(hitlTimerInterval);
      hitlTimerInterval = null;
      timerEl.textContent = 'Timed out';
    } else {
      timerEl.textContent = `Auto-deny in ${remaining}s`;
    }
  }, 1000);

  addSystemMessage(`âš  ${data.agent_name} needs approval to use: ${(data.tool_names || []).join(', ')}`);
}

function dismissHitlDialog() {
  const overlay = document.getElementById('hitlOverlay');
  if (overlay) overlay.remove();
  if (hitlTimerInterval) {
    clearInterval(hitlTimerInterval);
    hitlTimerInterval = null;
  }
}

async function respondHitl(requestId, decision) {
  const instructions = document.getElementById('hitlInstructions')?.value?.trim() || null;

  // Disable buttons immediately
  const overlay = document.getElementById('hitlOverlay');
  if (overlay) {
    overlay.querySelectorAll('.hitl-btn').forEach(b => b.disabled = true);
  }

  try {
    const r = await fetch(`${API}/hitl/respond`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({
        request_id: requestId,
        decision: decision,
        instructions: instructions,
      }),
    });
    if (!r.ok) {
      const err = await r.json();
      addSystemMessage(`HITL error: ${err.detail || r.statusText}`);
    }
    // Dialog will be dismissed by the hitl_approved / hitl_denied SSE event
  } catch (err) {
    addSystemMessage(`HITL error: ${err.message}`);
    dismissHitlDialog();
  }
}
</script>
</body>
</html>
